var controllers=angular.module("controllers",[]);siteUrl="http://lph-local.dev-srv.net/php/enpii/16/np_16014_kelle",ajaxUrl=siteUrl+"/api/web/v1",app.controller("MainController",["$scope","$location","$window",function(t,a,e){t.loggedIn=function(){return Boolean(e.sessionStorage.access_token)},t.logout=function(){delete e.sessionStorage.access_token,a.path("/login").replace()}}]),app.controller("LoginController",["$scope","$http","$window","$location",function(t,a,e,i){t.login=function(){t.submitted=!0,t.error={},a.post(ajaxUrl+"/user/login",t.userModel).success(function(t){console.log(t),e.sessionStorage.access_token=t.access_token,e.sessionStorage.building_id=t.building_id,i.path("/dashboard").replace()}).error(function(a){angular.forEach(a,function(a){t.error[a.field]=a.message})})}}]),app.controller("DashboardController",["$scope","$http","$window",function(t,a,e){function i(t){return t.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,"")}building_id=e.sessionStorage.building_id,void 0!==building_id&&null!=building_id&&(jQuery.get(ajaxUrl+"/buildings/view-building?id="+building_id,function(a){t.building=a,$("#building-name").html(a.name),blocks=a.building_facilities,blockFilter="",floorFilter="",facilityIdFilter="",blockHtml="";var e=[];jQuery.each(blocks,function(t,a){blockFilter+='<option value="#block-'+i(a.block)+'">'+a.block+"</option>",floorFilter+='<option value="#floor-'+i(a.floor)+'">'+a.floor+"</option>",facilityIdFilter+='<option value="#facilityID-'+i(a.facility_name)+'">'+a.facility_name+"</option>",blockHtml+='<li class="block-item" data-block-name="#block-'+i(a.block)+'" data-floor="#floor-'+i(a.floor)+'" data-facility-id="#facilityID-'+i(a.facility_name)+'"><a href="#/facility/'+a.id+'"><div class="block-info"><div class="block-title">'+a.block+'</div><div class="block-info-item"><label>Floor: </label>'+a.floor+'</div><div class="block-info-item"><label>Facility Type: </label>'+a.facility.facility_type+'</div><div class="block-info-item"><label>Facility ID:</label>'+a.facility_name+'</div></div><div class="block-rating"><select id="block-rating-'+a.id+'" class="block-rating-star" data-current-rating="'+a.rating+'"> <option value=""></option> <option value="1"></option> <option value="2"></option> <option value="3"></option> <option value="4"></option> <option value="5"></option> </select><div class="block-rating-number">'+a.rating+'</div><div class="block-rating-label">Ratings</div></div><div class="clearfix" ></div></a></li>',e.push("block-rating-"+a.id)}),$("#block-filter").html(blockFilter),$("#floor-filter").html(floorFilter),$("#facility-filter").html(facilityIdFilter),$("#block-list").html(blockHtml),$.each(e,function(t,a){blockID=$("#"+a),blockID.barrating({theme:"fontawesome-stars-o",readonly:!0,deselectable:!1,showSelectedRating:!1,initialRating:blockID.data("current-rating")})})}),$("#block-filter").change(function(){$(".block-item").hide(),$("[data-block-name='"+$(this).val()+"']").show()}),$("#floor-filter").change(function(){$(".block-item").hide(),$("[data-floor='"+$(this).val()+"']").show()}),$("#facility-filter").change(function(){$(".block-item").hide(),$("[data-facility-id='"+$(this).val()+"']").show()}))}]),app.controller("FacilityController",["$scope","$location","$window","$routeParams",function(t,a,e,i){jQuery.get(ajaxUrl+"/buildings/view-facility?id="+i.id,function(a){var i=[];t.facility=a,console.log(a),$("#building-name").html(a.building.name),$("#facility-name").html(a.block),$("#facility-date").html(a.created_at),$("#facility-floor").html(a.floor),$("#facility-type").html(a.facility.facility_type),$("#facility-id").html(a.facility_name),$("#request-adhoc a").attr("href","#/request-adhoc/"+a.id),tasks=a.tasks,tasksHtml="",jQuery.each(tasks,function(t,a){attachments=a.attachments,images="",jQuery.each(attachments,function(t,a){void 0!=a.thumbnail&&(images+='<li><a class="popup-image" href="'+a.thumbnail+'" class="image-thumbnail"  style="background-image: url('+a.thumbnail+')"></a></li>')}),tasksHtml+='<li class="task-item" id="task-rating-'+a.id+'"> <div class="inner"> <div class="container"> <div class="task-item-title">'+a.name+'</div> <div class="task-action"> <select  class="block-rating-star" data-current-rating="'+a.rating+'"> <option value=""></option> <option value="1"></option> <option value="2"></option> <option value="3"></option> <option value="4"></option> <option value="5"></option> </select> <a class="edit-facility" href="#/task/'+a.id+'">Edit</a> <a class="rate-task-btn hidden" data-value="'+a.rating+'" href="/buildings/rate-task?id='+a.id+'">Rate</a> </div> </div> <div class="image-control"> <ul class="image-list">'+images+'<li><a class="image-button btn-image-update" href="#/update-image-task/'+a.id+'"><i class="fa fa-camera" aria-hidden="true"></i></a> </li></ul></div> </div> </li>',i.push(a.id)}),$("#task-list").html(tasksHtml),$("a.popup-image").colorbox({rel:"popup-image"}),$(document).ready(function(){$.each(i,function(t,a){taskID=$("#task-rating-"+a),taskRating=taskID.find(".block-rating-star"),taskRating.barrating({theme:"fontawesome-stars-o",readonly:!1,deselectable:!1,showSelectedRating:!1,initialRating:taskRating.data("current-rating"),onSelect:function(t,a,i){parentElement=$(i.currentTarget).closest(".task-item"),currentVal=taskRating.data("current-rating"),t!=currentVal&&(parentElement.find(".rate-task-btn").attr("data-value",t),parentElement.find(".rate-task-btn").removeClass("hidden"),parentElement.find(".edit-facility").addClass("hidden"),parentElement.find(".rate-task-btn").click(function(t){t.preventDefault(),self=this,t.preventDefault(),jQuery.ajax({url:ajaxUrl+$(self).attr("href"),type:"post",data:{access_token:e.sessionStorage.access_token,value:$(self).attr("data-value")},success:function(t){200==t.status&&($(self).addClass("hidden"),$(self).parent().find(".edit-facility").removeClass("hidden"))}})}))}})})})})}]),app.controller("TaskController",["$scope","$location","$window","$routeParams",function(t,a,e,i){jQuery.get(ajaxUrl+"/buildings/view-task?id="+i.id,function(a){t.facility=a,taskImages=a.mediaRelations,images="",jQuery.each(taskImages,function(t,a){a.attachment&&(images+='<li class="image-item"> <a data-toggle="modal" data-target="#image-gallery"  data-image-id="'+a.attachment.id+'" class="popup-image" data-image="'+a.attachment.full+'" href="'+a.attachment.full+'" style="background-image: url('+a.attachment.thumbnail+')"></a></li>')}),$("#task-name").html(a.name),$("#task-image-list").html(images),$("#task-rating-value").val(a.latestRating),taskRating=$("#single-task-rating"),currentRating=taskRating.attr("data-current-rating",a.latestRating),taskRating.barrating({theme:"fontawesome-stars-o",readonly:!1,deselectable:!1,showSelectedRating:!1,initialRating:a.latestRating,onSelect:function(t,a,e){parentElement=$(e.currentTarget).closest(".task-item"),currentVal=taskRating.data("current-rating"),t!=currentVal&&$("#task-rating-value").val(t)}}),$("a.popup-image").colorbox({rel:"popup-image"})}),$("#submit-rating").click(function(t){t.preventDefault(),jQuery.ajax({url:ajaxUrl+"/buildings/rate-task?id="+i.id,type:"post",data:{access_token:e.sessionStorage.access_token,value:$("#task-rating-value").val()},beforeSend:function(){$(".status-message").addClass("hidden")},success:function(t){200==t.status?$("#success-message").removeClass("hidden").find(".inner").html(t.message):$("#error-message").removeClass("hidden").find(".inner").html(t.message)}})})}]),app.controller("TaskUpdateImageController",["$scope","$location","$window","$routeParams",function(t,a,e,i){function l(t,a,e,i){return image="",id=void 0!=a?a:"",void 0!=i&&(image='<img src="'+i+'" class="image-thumbnail">'),mediaId=void 0!=e?e:"",dynamicItem='<tr class="dynamic-form-item"><td><div class="image-preview">'+image+'</div></td><td><input type="hidden" id="taskrelationmedia-'+t+'-id" name="TaskRelationMedia['+t+'][id]" value="'+id+'"><input type="hidden" id="taskrelationmedia-'+t+'-media_id" name="TaskRelationMedia['+t+'][media_id]" value="'+mediaId+'"><input type="hidden" id="taskrelationmedia-'+t+'-deleteimg" name="TaskRelationMedia['+t+'][deleteImg]"><input type="hidden" name="TaskRelationMedia['+t+'][attachment]" value=""><div class="btn btn-default btn-file">Choose Image<input class="attachment-image-input" type="file" name="TaskRelationMedia['+t+'][attachment]" value="'+id+'"></div><button class="btn btn-default btn-danger delete-form-item">Delete</button></td></tr>',dynamicItem}jQuery.get(ajaxUrl+"/buildings/update-image-task?id="+i.id,function(t){function a(t){if(t.files&&t.files[0]){var a=new FileReader;a.onload=function(a){$(t).closest(".dynamic-form-item").find(".image-preview").html('<img src="'+a.target.result+'">')},a.readAsDataURL(t.files[0])}}console.log(t),mediaRelations=t.mediaRelations,images="",fileIndex=0,maxValueID=0,$("#task-name").val(t.name),jQuery.each(mediaRelations,function(t,a){void 0!=a.attachment&&(a.attachment.id>maxValueID&&(maxValueID=a.attachment.id),imageUrl=void 0!=a.attachment.thumbnail?a.attachment.thumbnail:"",images+=l(fileIndex,a.id,a.media_id,imageUrl),fileIndex++)}),images+='<tr> <td colspan="2" class="text-center v-middle "> <button type="button" class="add-item btn btn-success btn-sm"><span class="fa fa-plus"></span> New</button> </td> </tr>',$("#task-title").html(t.name),$("#task-image-list").html(images),$(".add-item").click(function(t){t.preventDefault(),maxValueID++,$(this).closest("tr").before(l(fileIndex,maxValueID)),fileIndex++,$(".attachment-image-input").change(function(){a(this)})}),$(".delete-form-item").click(function(){$(this).closest(".dynamic-form-item").remove()}),$(".attachment-image-input").change(function(){a(this)}),$("#dynamic-form-submit").click(function(t){t.preventDefault();var a=new FormData($(this).parents("form")[0]);return $.ajax({url:ajaxUrl+"/buildings/update-image-task?id="+i.id,type:"POST",xhr:function(){var t=$.ajaxSettings.xhr();return t},success:function(t){console.log(t),200==t.status&&e.location.reload()},data:a,cache:!1,contentType:!1,processData:!1}),!1})})}]),app.controller("RequestController",["$scope","$location","$window","$routeParams",function(t,a,e,i){jQuery.get(ajaxUrl+"/buildings/view-facility?id="+i.id,function(t){$("#request-building-name").val(t.building.name),$("#request-block-name").val(t.block),$("#request-facility-id").val(t.facility.facility_type),tasks=t.tasks,tasksHtml="",jQuery.each(tasks,function(t,a){tasksHtml+='<label class="checkbox-item"><input type="checkbox" id="checkbox-item-'+t+'" name="BuildingFacility[tasks][]" value="'+a.id+'" checked=""> <label for="checkbox-item-'+t+'">'+a.name+"</label></label>"}),$("#building-tasks").html(tasksHtml)}),$("#request-adhoc-btn").click(function(t){t.preventDefault(),fromRequest=$("#request-form"),formData=fromRequest.serializeArray(),formData.push({name:"access_token",value:e.sessionStorage.access_token}),buttonText=$(this).html(),jQuery.ajax({url:ajaxUrl+"/buildings/request-adhoc?id="+i.id,type:"post",data:formData,beforeSend:function(){fromRequest.find("#message").hide(),fromRequest.find("button[type=submit]").attr("disabled",!0),fromRequest.find("button[type=submit]").html("Processing...")},complete:function(){fromRequest.find("button[type=submit]").attr("disabled",!1),fromRequest.find("button[type=submit]").html(buttonText)},success:function(t){obj=jQuery.parseJSON(t),200==obj.status&&(fromRequest.trigger("reset"),fromRequest.find("#message").html(obj.message),fromRequest.find("#message").show())}})})}]),app.controller("LogoutController",["$location","$window",function(t,a){a.sessionStorage.clear(),t.path("/")}]);