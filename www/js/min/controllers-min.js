var controllers=angular.module("controllers",[]);siteUrl="http://top3.dev-srv.net/16/kelle",ajaxUrl=siteUrl+"/api/web/v1",app.controller("MainController",["$scope","$location","$window",function(t,e,a){t.loggedIn=function(){return Boolean(a.sessionStorage.access_token)},t.logout=function(){delete a.sessionStorage.access_token,e.path("/login").replace()},void 0!=a.sessionStorage.access_token&&e.path("/dashboard")}]),app.controller("LoginController",["$scope","$http","$window","$location",function(t,e,a,i){t.login=function(){t.submitted=!0,t.dataLoading=!0,t.error={},e.post(ajaxUrl+"/user/login",t.userModel).success(function(e){t.dataLoading=!1,a.sessionStorage.access_token=e.access_token,a.sessionStorage.building_id=e.building_id,a.sessionStorage.user_type=e.user_type,i.path("/dashboard").replace()}).error(function(e){t.dataLoading=!1,angular.forEach(e,function(e){t.error[e.field]=e.message})})}}]),app.controller("HomeController",["$scope","$http","$window","$location",function(t,e,a,i){}]),app.controller("DashboardController",["$scope","$http","$window",function(t,e,a){function i(t){return t.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,"")}void 0!=localStorage.scrollTo&&"DashboardController"==t.controllerName&&$("html, body").animate({scrollTop:localStorage.scrollTo-30},800,function(){}),building_id=a.sessionStorage.building_id,void 0!==building_id&&null!=building_id&&(jQuery.get(ajaxUrl+"/buildings/view-building?id="+building_id,function(t){$("#building-name").html(t.name),blocks=t.building_facilities,blockFilter="",blockFilterData=t.filterBlocks,jQuery.each(blockFilterData,function(t,e){blockFilter+='<option value="#block-'+i(e.block)+'">'+e.block+"</option>"}),floorFilter="",floorFilterData=t.filterFloors,jQuery.each(floorFilterData,function(t,e){floorFilter+='<option value="#floor-'+i(e.floor)+'">'+e.floor+"</option>"}),facilityIdFilter="",facilityIdFilterData=t.filterFacilities,jQuery.each(facilityIdFilterData,function(t,e){facilityIdFilter+='<option value="#facilityID-'+i(e.facility_name)+'">'+e.facility_name+"</option>"}),blockHtml="";var e=[];jQuery.each(blocks,function(t,a){blockHtml+='<li class="block-item" data-block-name="#block-'+i(a.block)+'" data-floor="#floor-'+i(a.floor)+'" data-facility-id="#facilityID-'+i(a.facility_name)+'" data-created-at="'+a.created_at+'"><a class="scroll-to-anchor" href="#/facility/'+a.id+'"><div class="block-info"><div class="block-title">'+a.block+'</div><div class="block-info-item"><label>Floor: </label>'+a.floor+'</div><div class="block-info-item"><label>Facility Type: </label>'+a.facility.facility_type+'</div><div class="block-info-item"><label>Facility ID:</label>'+a.facility_name+'</div></div><div class="block-rating"><select id="block-rating-'+a.id+'" class="block-rating-star" data-current-rating="'+a.rating+'"> <option value=""></option> <option value="1"></option> <option value="2"></option> <option value="3"></option> <option value="4"></option> <option value="5"></option> </select><div class="block-rating-number">'+a.rating+'</div><div class="block-rating-label">Ratings</div></div><div class="clearfix" ></div></a></li>',e.push("block-rating-"+a.id)}),$("#block-filter").html(blockFilter),$("#floor-filter").html(floorFilter),$("#facility-filter").html(facilityIdFilter),$("#block-list").html(blockHtml).delegate(".scroll-to-anchor","click",function(){localStorage.scrollTo=$(this).offset().top}),$.each(e,function(t,e){blockID=$("#"+e),blockID.barrating({theme:"fontawesome-stars-o",readonly:!0,deselectable:!1,showSelectedRating:!1,initialRating:blockID.data("current-rating")})})}),$("#block-status-filter").datepicker({format:"dd-MM-yyyy"}).on("show",function(){$(this).blur()}).on("changeDate",function(){$filterOrigin=new Date($(this).val()),$(".block-item").each(function(t){$block=$(this),$filterCompareVal=new Date($block.attr("data-created-at")),$filterOrigin.getDate()<=$filterCompareVal.getDate()?$block.show():$block.hide()})}),$("#block-filter").change(function(){$(".block-item").hide(),$("[data-block-name='"+$(this).val()+"']").show()}),$("#floor-filter").change(function(){$(".block-item").hide(),$("[data-floor='"+$(this).val()+"']").show()}),$("#facility-filter").change(function(){$(".block-item").hide(),$("[data-facility-id='"+$(this).val()+"']").show()}))}]),app.controller("FacilityController",["$scope","$location","$window","$routeParams",function(t,e,a,i){"admin"==a.sessionStorage.user_type||"supervisor"==a.sessionStorage.user_type?isReadOnly=!1:isReadOnly=!0,console.log(t.controllerName),console.log(localStorage.scrollToFacility),void 0!=localStorage.scrollToFacility&&"FacilityController"==t.controllerName&&$("html, body").animate({scrollTop:localStorage.scrollToFacility-30},800,function(){}),jQuery.get(ajaxUrl+"/buildings/view-facility?id="+i.id,function(e){var i=[];t.facility=e,$("#building-name").html(e.building.name),$("#facility-name").html(e.block),$("#facility-date").html(e.created_at),$("#facility-floor").html(e.floor),$("#facility-type").html(e.facility.facility_type),$("#facility-id").html(e.facility_name),$("#request-adhoc a").attr("href","#/request-adhoc/"+e.id),isReadOnly&&$("#request-adhoc a").hide(),tasks=e.tasks,tasksHtml="",jQuery.each(tasks,function(t,a){attachments=a.attachments,images="",imageCounter=0,jQuery.each(attachments,function(e,a){void 0!=a.thumbnail&&(imageCounter++,images+='<li><a rel="image-row-'+t+' " class="popup-image" href="'+a.medium+'" class="image-thumbnail"  style="background-image: url('+a.thumbnail+')"><img src="'+a.thumbnail+'"></a></li>')}),isReadOnly?(ratetaskButton="",updateImageButton=""):(ratetaskButton='<a class="rate-task-btn hidden" data-value="'+a.rating+'" href="/buildings/rate-task?id='+a.id+"&buildingFacilityID="+e.id+'">Rate</a> ',updateImageButton='<li><a class="scroll-to-anchor image-button btn-image-update" href="#/update-image-task/'+a.id+"/"+e.id+'"><span><i class="fa fa-camera" aria-hidden="true"></i></span><img src="img/transparent-img.png" width="1" height="1"></a> </li>',imageCounter>=4&&(updateImageButton="")),tasksHtml+='<li class="task-item" id="task-rating-'+a.id+'"> <div class="inner"> <div class="container"> <div class="task-item-title">'+a.name+'</div> <div class="task-action"> <select  class="block-rating-star" data-current-rating="'+a.rating+'"> <option value=""></option> <option value="1"></option> <option value="2"></option> <option value="3"></option> <option value="4"></option> <option value="5"></option> </select> <a class="scroll-to-anchor edit-facility" href="#/task/'+a.id+"/"+e.id+'">Edit</a> '+ratetaskButton+'</div> </div> <div class="image-control"> <ul class="image-list">'+images+updateImageButton+"</ul></div> </div> </li>",i.push(a.id)}),$("#task-list").html(tasksHtml).delegate(".scroll-to-anchor","click",function(){localStorage.scrollToFacility=$(this).offset().top}),$("a.popup-image").colorbox({rel:$(this).attr("rel"),maxWidth:"95%",maxHeight:"95%",previous:' <i class="fa fa-chevron-left"></i>',next:'<i class="fa fa-chevron-right"></i>'}),$(document).ready(function(){$.each(i,function(t,e){taskID=$("#task-rating-"+e),taskRating=taskID.find(".block-rating-star"),taskRating.barrating({theme:"fontawesome-stars-o",readonly:isReadOnly,deselectable:!1,showSelectedRating:!1,initialRating:taskRating.data("current-rating"),onSelect:function(t,e,i){parentElement=$(i.currentTarget).closest(".task-item"),currentVal=taskRating.data("current-rating"),t!=currentVal&&(parentElement.find(".rate-task-btn").attr("data-value",t),parentElement.find(".rate-task-btn").removeClass("hidden"),parentElement.find(".edit-facility").addClass("hidden"),parentElement.find(".rate-task-btn").click(function(t){t.preventDefault(),self=this,t.preventDefault(),jQuery.ajax({url:ajaxUrl+$(self).attr("href"),type:"post",data:{access_token:a.sessionStorage.access_token,value:$(self).attr("data-value")},success:function(t){200==t.status&&($(self).addClass("hidden"),$(self).parent().find(".edit-facility").removeClass("hidden"))}})}))}})})})})}]),app.controller("TaskController",["$scope","$location","$window","$routeParams",function(t,e,a,i){"admin"==a.sessionStorage.user_type||"supervisor"==a.sessionStorage.user_type?isReadOnly=!1:isReadOnly=!0,isReadOnly&&$(".submit-rating").hide(),jQuery.get(ajaxUrl+"/buildings/view-task?id="+i.id+"&buildingFacilityID="+i.facility,function(e){t.facility=e,taskImages=e.mediaRelations,images="",jQuery.each(taskImages,function(t,e){e.attachment&&(images+='<li class="image-item"> <a data-toggle="modal" data-target="#image-gallery"  data-image-id="'+e.attachment.id+'" class="popup-image" data-image="'+e.attachment.medium+'" href="'+e.attachment.medium+'" style="background-image: url('+e.attachment.thumbnail+')"><img src="'+e.attachment.thumbnail+'"></a></li>')}),updateImageButton="",isReadOnly||(updateImageButton='<li class="image-item"><a class="image-button btn-image-update" href="#/update-image-task/'+i.id+"/"+i.facility+'"><span><i class="fa fa-camera" aria-hidden="true"></i></span><img src="img/transparent-img.png" width="1" height="1"></a> </li>'),$("#task-name").html(e.name),$("#task-image-list").html(images+updateImageButton),$("#task-rating-value").val(e.latestRating),taskRating=$("#single-task-rating"),currentRating=taskRating.attr("data-current-rating",e.latestRating),taskRating.barrating({theme:"fontawesome-stars-o",readonly:isReadOnly,deselectable:!1,showSelectedRating:!1,initialRating:e.latestRating,onSelect:function(t,e,a){parentElement=$(a.currentTarget).closest(".task-item"),currentVal=taskRating.data("current-rating"),t!=currentVal&&$("#task-rating-value").val(t)}}),$("a.popup-image").colorbox({rel:$(this).attr("rel"),maxWidth:"95%",maxHeight:"95%",previous:' <i class="fa fa-chevron-left"></i>',next:'<i class="fa fa-chevron-right"></i>'})}),buttonText=$("#submit-rating").html(),$("#submit-rating").click(function(t){t.preventDefault(),formSubmit=$("#single-task-form"),jQuery.ajax({url:ajaxUrl+"/buildings/rate-task?id="+i.id+"&buildingFacilityID="+i.facility,type:"post",data:{access_token:a.sessionStorage.access_token,value:$("#task-rating-value").val()},beforeSend:function(){$(".status-message").addClass("hidden"),formSubmit.find("button[type=submit]").attr("disabled",!0),formSubmit.find("button[type=submit]").html("Processing...")},complete:function(){formSubmit.find("button[type=submit]").attr("disabled",!1),formSubmit.find("button[type=submit]").html(buttonText)},success:function(t){200==t.status?a.history.back():$("#error-message").removeClass("hidden").find(".inner").html(t.message)}})})}]),app.controller("TaskUpdateImageController",["$scope","$location","$window","$routeParams",function(t,e,a,i){function n(){u=navigator.camera.PictureSourceType,m=navigator.camera.DestinationType}function l(t){var e=document.getElementById("smallImage");e.style.display="block",e.src="data:image/jpeg;base64,"+t}function o(t){var e=document.getElementById("largeImage");e.style.display="block",e.src=t}function s(){navigator.camera.getPicture(l,c,{quality:50,destinationType:m.DATA_URL})}function r(){navigator.camera.getPicture(l,c,{quality:20,allowEdit:!0,destinationType:m.DATA_URL})}function c(t){console.log("Failed because: "+t)}function d(t,e,a,i){return image="",id=void 0!=e?e:"",void 0!=i&&(image='<img src="'+i+'" class="image-thumbnail">'),mediaId=void 0!=a?a:"",dynamicItem='<tr class="dynamic-form-item"><td><div class="image-preview">'+image+'</div></td><td><input type="hidden" id="taskrelationmedia-'+t+'-id" name="TaskRelationMedia['+t+'][id]" value="'+id+'"><input type="hidden" id="taskrelationmedia-'+t+'-media_id" name="TaskRelationMedia['+t+'][media_id]" value="'+mediaId+'"><input type="hidden" id="taskrelationmedia-'+t+'-deleteimg" name="TaskRelationMedia['+t+'][deleteImg]"><input type="hidden" name="TaskRelationMedia['+t+'][attachment]" value=""><div class="btn btn-default btn-file ">Choose Image<input  accept="image/*;capture=camera"  class="attachment-image-input" type="file" name="TaskRelationMedia['+t+'][attachment]" value="'+id+'"></div><button type="button" class="btn btn-default btn-danger btn-capture">Delete</button></td></tr>',dynamicItem}var u,m;document.addEventListener("deviceready",n,!1),jQuery.get(ajaxUrl+"/buildings/update-image-task?id="+i.id+"&buildingFacilityID="+i.facility,function(t){function e(t){if(t.files&&t.files[0]){var e=new FileReader;e.onload=function(e){$(t).closest(".dynamic-form-item").find(".image-preview").html('<img src="'+e.target.result+'">')},e.readAsDataURL(t.files[0])}}function n(t){if(1==t.target.files.length&&0==t.target.files[0].type.indexOf("image/")){var e=new FileReader;e.onload=function(e){$(t.target).closest(".dynamic-form-item").find(".image-preview").html('<img src="'+e.target.result+'">')},e.readAsDataURL(t.target.files[0])}}function l(t){navigator.camera.getPicture(o,c,{quality:50,destinationType:m.FILE_URI,sourceType:t})}mediaRelations=t.mediaRelations,images="",fileIndex=0,maxValueID=0,$("#task-name").val(t.name),jQuery.each(mediaRelations,function(t,e){void 0!=e.attachment&&(e.attachment.id>maxValueID&&(maxValueID=e.attachment.id),imageUrl=void 0!=e.attachment.thumbnail?e.attachment.thumbnail:"",images+=d(fileIndex,e.id,e.media_id,imageUrl),fileIndex++)}),images+='<tr> <td colspan="2" class="text-center v-middle "> <button type="button" class="add-item btn btn-success btn-sm"><span class="fa fa-plus"></span> New</button> </td> </tr>',$("#task-title").html(t.name),$("#task-image-list").html(images),$(".add-item").click(function(t){t.preventDefault(),maxValueID++,fileIndex<=3&&($(this).closest("tr").before(d(fileIndex,maxValueID)),fileIndex++,$(".attachment-image-input").change(n)),fileIndex>=4&&$(".add-item").hide(),$(".delete-form-item").click(function(){$(this).closest(".dynamic-form-item").remove(),fileIndex--,fileIndex<=3&&$(".add-item").show()})}),fileIndex>=4&&$(".add-item").hide(),$(".delete-form-item").click(function(){$(this).closest(".dynamic-form-item").remove(),fileIndex--,fileIndex<=3&&$(".add-item").show()}),$(".attachment-image-input").change(n),$(".btn-capture").click(l),$("#dynamic-form-submit").click(function(t){t.preventDefault(),buttonText=$(this).html();var e=$("#dynamic-form"),n=new FormData($(this).parents("form")[0]);return $.ajax({url:ajaxUrl+"/buildings/update-image-task?id="+i.id+"&buildingFacilityID="+i.facility,type:"POST",xhr:function(){var t=$.ajaxSettings.xhr();return t},beforeSend:function(){e.find("button[type=submit]").attr("disabled",!0),e.find("button[type=submit]").html("Processing...")},complete:function(){e.find("button[type=submit]").attr("disabled",!1),e.find("button[type=submit]").html(buttonText)},success:function(t){200==t.status?a.history.back():$("#error-message").removeClass("hidden").find(".inner").html(t.message)},data:n,cache:!1,contentType:!1,processData:!1}),!1})})}]),app.controller("RequestController",["$scope","$location","$window","$routeParams",function(t,e,a,i){jQuery.get(ajaxUrl+"/buildings/view-facility?id="+i.id,function(t){$("#request-building-name").val(t.building.name),$("#request-block-name").val(t.block),$("#request-facility-id").val(t.facility.facility_type),tasks=t.tasks,tasksHtml="",jQuery.each(tasks,function(t,e){tasksHtml+='<label class="checkbox-item"><input type="checkbox" id="checkbox-item-'+t+'" name="BuildingFacility[tasks][]" value="'+e.id+'" checked=""> <label for="checkbox-item-'+t+'">'+e.name+"</label></label>"}),$("#building-tasks").html(tasksHtml)}),buttonText=$("#request-adhoc-btn").html(),$("#request-adhoc-btn").click(function(t){t.preventDefault(),fromRequest=$("#request-form"),formData=fromRequest.serializeArray(),formData.push({name:"access_token",value:a.sessionStorage.access_token}),console.log(buttonText),jQuery.ajax({url:ajaxUrl+"/buildings/request-adhoc?id="+i.id,type:"post",data:formData,beforeSend:function(){fromRequest.find("#message").hide(),fromRequest.find("button[type=submit]").attr("disabled",!0),fromRequest.find("button[type=submit]").html("Processing...")},complete:function(){fromRequest.find("button[type=submit]").attr("disabled",!1),fromRequest.find("button[type=submit]").html(buttonText)},success:function(t){obj=jQuery.parseJSON(t),200==obj.status?$("#success-message").removeClass("hidden").find(".inner").html(obj.message):$("#error-message").removeClass("hidden").find(".inner").html(obj.message)},error:function(t,e,a){$("#error-message").removeClass("hidden").find(".inner").html(a.message)}})})}]),app.controller("LogoutController",["$location","$window",function(t,e){e.sessionStorage.clear(),t.path("/")}]);